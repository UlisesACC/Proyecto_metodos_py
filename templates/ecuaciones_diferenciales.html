<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecuaciones Diferenciales - M√©todos Num√©ricos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #333;
            color: white;
            text-decoration: none;
            font-size: 1rem;
        }

        .section {
            background: white;
            border: 1px solid #999;
            padding: 15px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .accordion {
            border: 1px solid #999;
        }

        .accordion-item {
            border-bottom: 1px solid #999;
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-header {
            background-color: #f5f5f5;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            border: none;
            width: 100%;
            text-align: left;
        }

        .accordion-header:hover {
            background-color: #efefef;
        }

        .accordion-header.active {
            background-color: #ddd;
        }

        .accordion-header::after {
            content: '‚ñº';
            font-size: 0.8rem;
        }

        .accordion-header.active::after {
            transform: rotate(180deg);
        }

        .accordion-content {
            display: none;
            padding: 15px;
            background-color: white;
        }

        .accordion-content.show {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group small {
            display: block;
            color: #666;
            font-size: 0.85rem;
            margin-top: 3px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #999;
            font-size: 1rem;
            font-family: monospace;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-calcular {
            background-color: #333;
            color: white;
        }

        .btn-limpiar {
            background-color: #ccc;
            color: #000;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #999;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-value {
            background-color: #eee;
            padding: 10px;
            border: 1px solid #999;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .tabla th,
        .tabla td {
            border: 1px solid #999;
            padding: 6px;
            text-align: center;
        }

        .tabla th {
            background-color: #ddd;
            font-weight: bold;
        }

        .error {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border: 1px solid #c99;
            margin-top: 15px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .hidden-fields {
            display: none;
        }

        .hidden-fields.show {
            display: block;
        }

        .formula-button {
            padding: 6px 10px;
            background-color: #f0f0f0;
            border: 1px solid #999;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Modal para f√≥rmulas */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #999;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
        }

        .modal-header {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .modal-formula {
            background-color: #f9f9f9;
            padding: 20px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1rem;
        }

        .modal-close {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>Ecuaciones Diferenciales Ordinarias</h1>
        </div>
    </nav>

    <main class="container">
        <a href="/" class="back-button">‚Üê Volver</a>

        <!-- Selector de M√©todo -->
        <div class="section">
            <h2>Selecciona un M√©todo</h2>
            <div class="accordion">
                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>M√©todos B√°sicos</span>
                    </button>
                    <div class="accordion-content">
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="euler" id="opt_euler" checked onchange="actualizarCampos()">
                            <label for="opt_euler">Euler</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('euler')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>M√©todos de Taylor</span>
                    </button>
                    <div class="accordion-content">
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="taylor_2" id="opt_taylor2" onchange="actualizarCampos()">
                            <label for="opt_taylor2">Taylor Orden 2</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('taylor_2')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="taylor_3" id="opt_taylor3" onchange="actualizarCampos()">
                            <label for="opt_taylor3">Taylor Orden 3</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('taylor_3')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                        <div>
                            <input type="radio" name="metodo" value="taylor_4" id="opt_taylor4" onchange="actualizarCampos()">
                            <label for="opt_taylor4">Taylor Orden 4</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('taylor_4')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>Runge-Kutta</span>
                    </button>
                    <div class="accordion-content">
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="rk3" id="opt_rk3" onchange="actualizarCampos()">
                            <label for="opt_rk3">Runge-Kutta Orden 3</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('rk3')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="rk4" id="opt_rk4" onchange="actualizarCampos()">
                            <label for="opt_rk4">Runge-Kutta Orden 4</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('rk4')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                        <div>
                            <input type="radio" name="metodo" value="rkf" id="opt_rkf" onchange="actualizarCampos()">
                            <label for="opt_rkf">Runge-Kutta-Fehlberg (4-5)</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('rkf')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>M√©todos Multi-paso</span>
                    </button>
                    <div class="accordion-content">
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="adams_b" id="opt_adamsb" onchange="actualizarCampos()">
                            <label for="opt_adamsb">Adams-Bashforth</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('adams_b')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                        <div>
                            <input type="radio" name="metodo" value="adams_m" id="opt_adamsm" onchange="actualizarCampos()">
                            <label for="opt_adamsm">Adams-Moulton</label>
                            <button type="button" class="formula-button" onclick="mostrarFormula('adams_m')" style="margin-left: 10px;">Ver f√≥rmula</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Entrada -->
        <div class="section">
            <h2>Ingresa los Datos</h2>
            <form id="formulario">
                <div class="form-group">
                    <label>Funciones del Sistema</label>
                    <div id="functionsContainer" style="margin-bottom: 15px;">
                        <div class="function-input-group" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label for="f_expr_1" style="font-size: 0.9em;">dy‚ÇÅ/dx = f‚ÇÅ(x, y‚ÇÅ, y‚ÇÇ, ...)</label>
                                <input 
                                    type="text" 
                                    id="f_expr_1" 
                                    class="f_expr_input"
                                    placeholder="ej: x + y1"
                                    required
                                >
                            </div>
                            <button type="button" class="btn-add-function" onclick="agregarFuncion()" style="padding: 8px 12px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">+</button>
                        </div>
                        <div id="additionalFunctions"></div>
                    </div>
                    <small>Usa 'x' para la variable independiente. Usa 'y1', 'y2', 'y3'... para las variables dependientes. Ej: y2 (primera funci√≥n), -y1 (segunda funci√≥n)</small>
                </div>

                <!-- Campos de derivadas con botones para Taylor -->
                <div id="derivadasSection" style="display: none;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <button 
                            type="button"
                            onclick="calcularTodasLasDerivadas(event)"
                            style="width: 100%; padding: 12px 20px; background-color: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s ease;"
                            onmouseover="this.style.backgroundColor='#7b1fa2'"
                            onmouseout="this.style.backgroundColor='#9c27b0'"
                        >
                            CALCULAR TODAS LAS DERIVADAS AUTOM√ÅTICAMENTE
                        </button>
                    </div>

                    <div class="form-group" id="df_group" style="display: none;">
                        <label for="df_expr">Primera Derivada f'(x, y)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input 
                                type="text" 
                                id="df_expr" 
                                placeholder="Se calcular√° autom√°ticamente"
                                readonly
                                style="flex: 1; background-color: #f0f0f0; color: #333; cursor: text;"
                            >
                            <button 
                                type="button" 
                                class="btn-calcular-derivada"
                                onclick="calcularDerivadaEspecifica('df')"
                                style="padding: 10px 20px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;"
                            >
                                f'
                            </button>
                        </div>
                    </div>

                    <div class="form-group" id="ddf_group" style="display: none;">
                        <label for="ddf_expr">Segunda Derivada f''(x, y)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input 
                                type="text" 
                                id="ddf_expr" 
                                placeholder="Se calcular√° autom√°ticamente"
                                readonly
                                style="flex: 1; background-color: #f0f0f0; color: #333; cursor: text;"
                            >
                            <button 
                                type="button" 
                                class="btn-calcular-derivada"
                                onclick="calcularDerivadaEspecifica('ddf')"
                                style="padding: 10px 20px; background-color: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;"
                            >
                                f''
                            </button>
                        </div>
                    </div>

                    <div class="form-group" id="dddf_group" style="display: none;">
                        <label for="dddf_expr">Tercera Derivada f'''(x, y)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input 
                                type="text" 
                                id="dddf_expr" 
                                placeholder="Se calcular√° autom√°ticamente"
                                readonly
                                style="flex: 1; background-color: #f0f0f0; color: #333; cursor: text;"
                            >
                            <button 
                                type="button" 
                                class="btn-calcular-derivada"
                                onclick="calcularDerivadaEspecifica('dddf')"
                                style="padding: 10px 20px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;"
                            >
                                f'''
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="x0">Condici√≥n Inicial x‚ÇÄ</label>
                    <input 
                        type="number" 
                        id="x0" 
                        placeholder="ej: 0"
                        step="0.01"
                        required
                    >
                </div>

                <div class="form-group">
                    <label>Condiciones Iniciales y‚ÇÄ</label>
                    <div id="y0Container">
                        <div class="y0-input-group" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <label for="y0_1" style="flex: 0 0 50px; padding-top: 8px;">y‚ÇÅ(x‚ÇÄ):</label>
                            <input 
                                type="number" 
                                id="y0_1" 
                                class="y0_input"
                                placeholder="ej: 1"
                                step="0.01"
                                required
                            >
                        </div>
                        <div id="additionalY0s"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="xf">Valor Final xf</label>
                    <input 
                        type="number" 
                        id="xf" 
                        placeholder="ej: 2"
                        step="0.01"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="n">N√∫mero de Pasos</label>
                    <input 
                        type="number" 
                        id="n" 
                        placeholder="ej: 10"
                        min="1"
                        required
                    >
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-calcular">Calcular</button>
                    <button type="reset" class="btn-limpiar">Limpiar</button>
                </div>
            </form>

            <div id="error" class="error"></div>
        </div>

        <!-- Secci√≥n de Resultados -->
        <div id="resultados" class="section results">
            <h2>Resultados</h2>
        </div>
    </main>

    <footer>
        <p>&copy; 2026 App de M√©todos Num√©ricos - ESCOM</p>
    </footer>

    <!-- Modal para f√≥rmulas -->
    <div id="formulaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle"></div>
            <div class="modal-formula" id="modalFormula"></div>
            <button class="modal-close" onclick="cerrarModal()">Cerrar</button>
        </div>
    </div>

    <script>
        // Inicializar variables globales
        let functionCount = 1;
        let y0Count = 1;

        const formulas = {
            'euler': {
                titulo: "M√©todo de Euler",
                latex: "y_{i+1} = y_i + h \\cdot f(x_i, y_i)"
            },
            'taylor_2': {
                titulo: "M√©todo de Taylor Orden 2",
                latex: "y_{i+1} = y_i + h \\cdot f(x_i, y_i) + \\frac{h^2}{2} \\cdot f'(x_i, y_i)"
            },
            'taylor_3': {
                titulo: "M√©todo de Taylor Orden 3",
                latex: "y_{i+1} = y_i + h \\cdot f + \\frac{h^2}{2} \\cdot f' + \\frac{h^3}{6} \\cdot f''"
            },
            'taylor_4': {
                titulo: "M√©todo de Taylor Orden 4",
                latex: "y_{i+1} = y_i + h \\cdot f + \\frac{h^2}{2} \\cdot f' + \\frac{h^3}{6} \\cdot f'' + \\frac{h^4}{24} \\cdot f'''"
            },
            'rk3': {
                titulo: "Runge-Kutta Orden 3",
                latex: "\\begin{align} k_1 &= f(x_i, y_i) \\\\ k_2 &= f(x_i + h/2, y_i + hk_1/2) \\\\ k_3 &= f(x_i + h, y_i - hk_1 + 2hk_2) \\\\ y_{i+1} &= y_i + \\frac{h}{6}(k_1 + 4k_2 + k_3) \\end{align}"
            },
            'rk4': {
                titulo: "Runge-Kutta Orden 4",
                latex: "\\begin{align} k_1 &= f(x_i, y_i) \\\\ k_2 &= f(x_i + h/2, y_i + hk_1/2) \\\\ k_3 &= f(x_i + h/2, y_i + hk_2/2) \\\\ k_4 &= f(x_i + h, y_i + hk_3) \\\\ y_{i+1} &= y_i + \\frac{h}{6}(k_1 + 2k_2 + 2k_3 + k_4) \\end{align}"
            },
            'rkf': {
                titulo: "Runge-Kutta-Fehlberg (4-5)",
                latex: "\\text{Combina dos m√©todos RK de orden 4 y 5 para estimar error} \\\\ y_{i+1} = y_i + h \\sum_{i} b_i k_i"
            },
            'adams_b': {
                titulo: "Adams-Bashforth (Multi-paso)",
                latex: "y_{n+1} = y_n + \\frac{h}{24}(55f_n - 59f_{n-1} + 37f_{n-2} - 9f_{n-3})"
            },
            'adams_m': {
                titulo: "Adams-Moulton (Impl√≠cito)",
                latex: "y_{n+1} = y_n + \\frac{h}{24}(9f_{n+1} + 19f_n - 5f_{n-1} + f_{n-2})"
            }
        };

        function mostrarFormula(metodo) {
            const modal = document.getElementById('formulaModal');
            const title = document.getElementById('modalTitle');
            const formula = document.getElementById('modalFormula');
            
            if (formulas[metodo]) {
                title.textContent = formulas[metodo].titulo;
                formula.innerHTML = '$$' + formulas[metodo].latex + '$$';
                modal.classList.add('show');
                
                MathJax.typesetPromise([formula]).catch(err => console.log(err));
            }
        }

        function cerrarModal() {
            document.getElementById('formulaModal').classList.remove('show');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('formulaModal');
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        }

        function toggleAccordion(button) {
            const content = button.nextElementSibling;
            button.classList.toggle('active');
            content.classList.toggle('show');
        }

        function actualizarCampos() {
            const metodo = document.querySelector('input[name="metodo"]:checked').value;
            const derivadasSection = document.getElementById('derivadasSection');
            const dfGroup = document.getElementById('df_group');
            const ddfGroup = document.getElementById('ddf_group');
            const dddfGroup = document.getElementById('dddf_group');

            // Ocultar todo por defecto
            derivadasSection.style.display = 'none';
            dfGroup.style.display = 'none';
            ddfGroup.style.display = 'none';
            dddfGroup.style.display = 'none';

            // Mostrar solo si es Taylor
            if (metodo === 'taylor_2') {
                derivadasSection.style.display = 'block';
                dfGroup.style.display = 'block';
            } else if (metodo === 'taylor_3') {
                derivadasSection.style.display = 'block';
                dfGroup.style.display = 'block';
                ddfGroup.style.display = 'block';
            } else if (metodo === 'taylor_4') {
                derivadasSection.style.display = 'block';
                dfGroup.style.display = 'block';
                ddfGroup.style.display = 'block';
                dddfGroup.style.display = 'block';
            }
        }

        async function calcularTodasLasDerivadas(evento) {
            let btnCalcular = null;
            try {
                const fExprInput = document.querySelector('.f_expr_input');
                
                if (!fExprInput) {
                    alert('‚ùå No se encontr√≥ la funci√≥n');
                    return;
                }
                
                const fExpr = fExprInput.value.trim();
                if (!fExpr) {
                    alert('‚ùå Por favor ingresa una funci√≥n primero');
                    return;
                }

                // Obtener el bot√≥n que gener√≥ el evento o buscarlo en el DOM
                btnCalcular = evento ? evento.target : document.querySelector('.form-group button[onclick*="calcularTodasLasDerivadas"]');
                if (!btnCalcular) {
                    btnCalcular = document.querySelector('[onclick*="calcularTodasLasDerivadas"]');
                }
                
                const textOriginal = btnCalcular ? btnCalcular.innerHTML : '';
                if (btnCalcular) {
                    btnCalcular.innerHTML = '‚è≥ Calculando derivadas...';
                    btnCalcular.disabled = true;
                }

                // Determinar el orden m√°ximo necesario seg√∫n el m√©todo seleccionado
                const metodo = document.querySelector('input[name="metodo"]:checked').value;
                let orden = 1;
                if (metodo === 'taylor_3') orden = 2;
                if (metodo === 'taylor_4') orden = 3;

                const response = await fetch('/api/calcular-derivadas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ f_expr: fExpr, orden: orden })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error en la respuesta del servidor');
                }

                const datos = await response.json();
                
                // Llenar los campos de derivadas
                if (document.getElementById('df_expr')) {
                    document.getElementById('df_expr').value = datos.df_expr || '';
                }
                if (document.getElementById('ddf_expr')) {
                    document.getElementById('ddf_expr').value = datos.ddf_expr || '';
                }
                if (document.getElementById('dddf_expr')) {
                    document.getElementById('dddf_expr').value = datos.dddf_expr || '';
                }

                // Restaurar bot√≥n
                if (btnCalcular) {
                    btnCalcular.innerHTML = '‚úÖ ¬°Derivadas Calculadas!';
                    setTimeout(() => {
                        btnCalcular.innerHTML = textOriginal;
                        btnCalcular.disabled = false;
                    }, 2000);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al calcular las derivadas: ' + error.message);
                if (btnCalcular) {
                    btnCalcular.disabled = false;
                    btnCalcular.innerHTML = 'üî¢ CALCULAR TODAS LAS DERIVADAS AUTOM√ÅTICAMENTE';
                }
            }
        }

        async function calcularDerivadaEspecifica(tipo) {
            try {
                const fExprInput = document.querySelector('.f_expr_input');
                
                if (!fExprInput) {
                    alert('‚ùå No se encontr√≥ la funci√≥n');
                    return;
                }
                
                const fExpr = fExprInput.value.trim();
                if (!fExpr) {
                    alert('‚ùå Por favor ingresa una funci√≥n primero');
                    return;
                }

                // Determinar el orden necesario
                let orden = 1;
                if (tipo === 'ddf') orden = 2;
                if (tipo === 'dddf') orden = 3;

                const response = await fetch('/api/calcular-derivadas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ f_expr: fExpr, orden: orden })
                });

                if (!response.ok) {
                    alert('‚ùå Error al calcular derivadas');
                    return;
                }

                const datos = await response.json();
                
                // Llenar el campo correspondiente
                if (tipo === 'df' && document.getElementById('df_expr')) {
                    document.getElementById('df_expr').value = datos.df_expr || '';
                }
                if (tipo === 'ddf' && document.getElementById('ddf_expr')) {
                    document.getElementById('ddf_expr').value = datos.ddf_expr || '';
                }
                if (tipo === 'dddf' && document.getElementById('dddf_expr')) {
                    document.getElementById('dddf_expr').value = datos.dddf_expr || '';
                }

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al calcular la derivada');
            }
        }

        // Calcular derivadas cuando cambia la funci√≥n o el m√©todo
        document.addEventListener('DOMContentLoaded', function() {
            // Listener en cambio de m√©todo (radios)
            const metodosRadios = document.querySelectorAll('input[name="metodo"]');
            metodosRadios.forEach(radio => {
                radio.addEventListener('change', actualizarCampos);
            });

            // Listener en cambio de funci√≥n (event delegation)
            const functionsContainer = document.getElementById('functionsContainer');
            if (functionsContainer) {
                functionsContainer.addEventListener('input', function(e) {
                    if (e.target.classList.contains('f_expr_input')) {
                        const metodo = document.querySelector('input[name="metodo"]:checked');
                        if (metodo && metodo.value.startsWith('taylor_')) {
                            // No calcular autom√°ticamente, dejar que el usuario presione el bot√≥n
                        }
                    }
                });
            }
        });

        const formulario = document.getElementById('formulario');
        const errorDiv = document.getElementById('error');
        const resultadosDiv = document.getElementById('resultados');

        formulario.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const metodo = document.querySelector('input[name="metodo"]:checked').value;
            const x0 = parseFloat(document.getElementById('x0').value);
            const xf = parseFloat(document.getElementById('xf').value);
            const n = parseInt(document.getElementById('n').value);
            
            // Recopilar todas las funciones
            const functionsElements = document.querySelectorAll('.f_expr_input');
            const functions = [];
            functionsElements.forEach(elem => {
                const val = elem.value.trim();
                if (val) functions.push(val);
            });
            
            // Recopilar todas las condiciones iniciales y0
            const y0Elements = document.querySelectorAll('.y0_input');
            const y0 = [];
            y0Elements.forEach(elem => {
                const val = parseFloat(elem.value);
                if (!isNaN(val)) y0.push(val);
            });

            errorDiv.classList.remove('show');
            errorDiv.textContent = '';

            try {
                if (isNaN(x0) || isNaN(xf) || isNaN(n)) {
                    throw new Error('Todos los valores deben ser n√∫meros v√°lidos');
                }
                if (functions.length === 0) {
                    throw new Error('Se requiere al menos una funci√≥n');
                }
                if (y0.length === 0) {
                    throw new Error('Se requiere al menos una condici√≥n inicial y0');
                }
                if (y0.length !== functions.length) {
                    throw new Error(`N√∫mero de funciones (${functions.length}) debe coincidir con el de condiciones iniciales (${y0.length})`);
                }

                const requestBody = {
                    metodo: metodo,
                    x0: x0,
                    y0: y0,
                    xf: xf,
                    n: n,
                    functions: functions
                };

                // Las derivadas de Taylor se calculan autom√°ticamente en el backend
                // No es necesario enviarlas

                const response = await fetch('/api/ecuaciones-diferenciales', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error en el servidor');
                }

                const data = await response.json();
                mostrarResultados(data);

            } catch (error) {
                errorDiv.textContent = '‚ùå ' + error.message;
                errorDiv.classList.add('show');
                resultadosDiv.classList.remove('show');
            }
        });

        function mostrarResultados(datos) {
            let html = '';

            html += '<div class="result-item">';
            html += '<div class="result-label">M√©todo Utilizado:</div>';
            html += '<div class="result-value">' + datos.detalles.metodo + '</div>';
            html += '</div>';

            html += '<div class="result-item">';
            html += '<div class="result-label">Par√°metros:</div>';
            html += '<div class="result-value">';
            html += 'x0 = ' + datos.detalles.x0 + '<br>';
            
            // Mostrar y0 como escalar o array
            if (Array.isArray(datos.detalles.y0)) {
                html += 'y0 = [' + datos.detalles.y0.join(', ') + ']<br>';
            } else {
                html += 'y0 = ' + datos.detalles.y0 + '<br>';
            }
            
            html += 'h = ' + datos.detalles.h.toFixed(6) + '<br>';
            html += 'n = ' + datos.detalles.n;
            html += '</div>';
            html += '</div>';

            html += '<div class="result-item">';
            html += '<div class="result-label">Tabla de Resultados:</div>';
            
            // Determinar si es sistema (y_valores es array de arrays) o ecuaci√≥n √∫nica (y_valores es array de arrays con un elemento)
            let numVars = datos.y_valores.length;
            let numPasos = datos.x_valores.length;
            
            html += '<table class="tabla"><thead><tr><th>x</th>';
            for (let j = 0; j < numVars; j++) {
                if (numVars === 1) {
                    html += '<th>y</th>';
                } else {
                    html += '<th>y' + (j + 1) + '</th>';
                }
            }
            html += '</tr></thead><tbody>';
            
            // Rellenar datos de la tabla
            for (let i = 0; i < numPasos; i++) {
                html += '<tr>';
                html += '<td>' + datos.x_valores[i].toFixed(6) + '</td>';
                for (let j = 0; j < numVars; j++) {
                    let val = datos.y_valores[j][i];
                    html += '<td>' + (val !== undefined && val !== null ? val.toFixed(6) : 'N/A') + '</td>';
                }
                html += '</tr>';
            }

            html += '</tbody></table>';
            html += '</div>';

            resultadosDiv.innerHTML = '<h2>Resultados</h2>' + html;
            resultadosDiv.classList.add('show');
        }


        // Funciones para agregar/quitar funciones y condiciones iniciales

        function agregarFuncion() {
            functionCount++;
            const container = document.getElementById('additionalFunctions');
            const newDiv = document.createElement('div');
            newDiv.className = 'function-input-group';
            newDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end;';
            newDiv.id = 'func-group-' + functionCount;
            
            newDiv.innerHTML = `
                <div style="flex: 1;">
                    <label for="f_expr_${functionCount}" style="font-size: 0.9em;">dy${functionCount}/dx = f${functionCount}(x, y‚ÇÅ, y‚ÇÇ, ...)</label>
                    <input 
                        type="text" 
                        id="f_expr_${functionCount}" 
                        class="f_expr_input"
                        placeholder="ej: -y1"
                    >
                </div>
                <button type="button" onclick="eliminarFuncion(${functionCount})" style="padding: 8px 12px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">-</button>
            `;
            
            container.appendChild(newDiv);
            agregarY0(); // Agregar condici√≥n inicial correspondiente
        }

        function eliminarFuncion(index) {
            const group = document.getElementById('func-group-' + index);
            if (group) {
                group.remove();
                functionCount--;
            }
            
            // Eliminar la condici√≥n inicial correspondiente
            const y0Group = document.getElementById('y0-group-' + index);
            if (y0Group) {
                y0Group.remove();
                y0Count--;
            }
        }

        function agregarY0() {
            y0Count++;
            const container = document.getElementById('additionalY0s');
            const newDiv = document.createElement('div');
            newDiv.className = 'y0-input-group';
            newDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            newDiv.id = 'y0-group-' + y0Count;
            
            newDiv.innerHTML = `
                <label for="y0_${y0Count}" style="flex: 0 0 50px; padding-top: 8px;">y${y0Count}(x‚ÇÄ):</label>
                <input 
                    type="number" 
                    id="y0_${y0Count}" 
                    class="y0_input"
                    placeholder="ej: 1"
                    step="0.01"
                >
                <button type="button" onclick="eliminarY0(${y0Count})" style="padding: 8px 12px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">-</button>
            `;
            
            container.appendChild(newDiv);
        }

        function eliminarY0(index) {
            const group = document.getElementById('y0-group-' + index);
            if (group) {
                group.remove();
                y0Count--;
            }
        }

        // Actualizar campos inicialmente
        actualizarCampos();
    </script>
</body>
</html>
