<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecuaciones de Una Variable - Métodos Numéricos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #333;
            color: white;
            text-decoration: none;
            font-size: 1rem;
        }

        .section {
            background: white;
            border: 1px solid #999;
            padding: 15px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .accordion {
            border: 1px solid #999;
        }

        .accordion-item {
            border-bottom: 1px solid #999;
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-header {
            background-color: #f5f5f5;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            border: none;
            width: 100%;
            text-align: left;
        }

        .accordion-header:hover {
            background-color: #efefef;
        }

        .accordion-header.active {
            background-color: #ddd;
        }

        .accordion-header::after {
            content: '▼';
            font-size: 0.8rem;
        }

        .accordion-header.active::after {
            transform: rotate(180deg);
        }

        .accordion-content {
            display: none;
            padding: 15px;
            background-color: white;
        }

        .accordion-content.show {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group small {
            display: block;
            color: #666;
            font-size: 0.85rem;
            margin-top: 3px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #999;
            font-size: 1rem;
            font-family: monospace;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-calcular {
            background-color: #333;
            color: white;
            flex: 1;
        }

        .btn-calcular:hover {
            background-color: #555;
        }

        .btn-limpiar {
            background-color: #ccc;
            color: #000;
        }

        .btn-limpiar:hover {
            background-color: #bbb;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #999;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-value {
            background-color: #eee;
            padding: 10px;
            border: 1px solid #999;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .tabla th,
        .tabla td {
            border: 1px solid #999;
            padding: 6px;
            text-align: center;
        }

        .tabla th {
            background-color: #ddd;
            font-weight: bold;
        }

        .error {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border: 1px solid #c99;
            margin-top: 15px;
            display: none;
        }

        .error.show {
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>Ecuaciones de Una Variable</h1>
        </div>
    </nav>

    <main class="container">
        <a href="/" class="back-button">← Volver</a>

        <!-- Selector de Método -->
        <div class="section">
            <h2>Selecciona un Método</h2>
            <div class="accordion">
                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>Métodos de Intervalo</span>
                    </button>
                    <div class="accordion-content">
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="biseccion" id="opt_biseccion" checked>
                            <label for="opt_biseccion">Bisección</label>
                        </div>
                        <div>
                            <input type="radio" name="metodo" value="falsa_posicion" id="opt_falsa_posicion">
                            <label for="opt_falsa_posicion">Falsa Posición</label>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>Métodos Abiertos</span>
                    </button>
                    <div class="accordion-content">
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="secante" id="opt_secante">
                            <label for="opt_secante">Secante</label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <input type="radio" name="metodo" value="newton_raphson" id="opt_newton">
                            <label for="opt_newton">Newton-Raphson</label>
                        </div>
                        <div>
                            <input type="radio" name="metodo" value="punto_fijo" id="opt_punto_fijo">
                            <label for="opt_punto_fijo">Punto Fijo</label>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span>Métodos Avanzados</span>
                    </button>
                    <div class="accordion-content">
                        <div>
                            <input type="radio" name="metodo" value="muller" id="opt_muller">
                            <label for="opt_muller">Müller</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Entrada de Datos -->
        <div class="section">
            <h2>Ingresa los Datos</h2>
            <form id="formulario">
                <div class="form-group">
                    <label for="funcion">Función f(x)</label>
                    <input type="text" id="funcion" name="funcion" placeholder="ej: x**2 - 4" required>
                    <small>Usa x como variable, ** para potencia, sqrt(), sin(), cos(), exp(), log()</small>
                </div>

                <!-- Parámetros para Bisección y Falsa Posición -->
                <div id="params_intervalo" style="display: none;">
                    <div class="form-group">
                        <label for="a">Límite inferior (a)</label>
                        <input type="number" id="a" name="a" step="0.0001" placeholder="ej: 1">
                    </div>
                    <div class="form-group">
                        <label for="b">Límite superior (b)</label>
                        <input type="number" id="b" name="b" step="0.0001" placeholder="ej: 3">
                    </div>
                </div>

                <!-- Parámetros para Secante, Newton-Raphson y Müller -->
                <div id="params_puntos_iniciales" style="display: none;">
                    <div class="form-group">
                        <label for="x0">Punto inicial x₀</label>
                        <input type="number" id="x0" name="x0" step="0.0001" placeholder="ej: 1">
                    </div>

                    <div id="params_x1" style="display: none;">
                        <div class="form-group">
                            <label for="x1">Punto x₁</label>
                            <input type="number" id="x1" name="x1" step="0.0001" placeholder="ej: 2">
                        </div>
                    </div>

                    <div id="params_x2" style="display: none;">
                        <div class="form-group">
                            <label for="x2">Punto x₂</label>
                            <input type="number" id="x2" name="x2" step="0.0001" placeholder="ej: 3">
                        </div>
                    </div>
                </div>

                <!-- Parámetros para Newton-Raphson -->
                <div id="params_derivada" style="display: none;">
                    <div class="form-group">
                        <label for="derivada">Derivada f'(x)</label>
                        <input type="text" id="derivada" name="derivada" placeholder="ej: 2*x">
                        <small>Derivada de f(x)</small>
                    </div>
                </div>

                <!-- Parámetros para Punto Fijo -->
                <div id="params_iteracion" style="display: none;">
                    <div class="form-group">
                        <label for="g">Función de iteración g(x)</label>
                        <input type="text" id="g" name="g" placeholder="ej: 4/x">
                        <small>Para resolver x = g(x)</small>
                    </div>
                </div>

                <!-- Parámetros comunes -->
                <div class="form-group">
                    <label for="tolerancia">Tolerancia</label>
                    <input type="number" id="tolerancia" name="tolerancia" step="0.00001" value="0.00001" required>
                </div>

                <div class="form-group">
                    <label for="max_iteraciones">Máximo de iteraciones</label>
                    <input type="number" id="max_iteraciones" name="max_iteraciones" value="100" required>
                </div>

                <div class="button-group">
                    <button type="button" class="btn-calcular" onclick="calcular()">Calcular</button>
                    <button type="button" class="btn-limpiar" onclick="limpiar()">Limpiar</button>
                </div>
            </form>

            <div id="error" class="error"></div>
        </div>

        <!-- Sección de Resultados -->
        <div id="resultados" class="section results">
            <h2>Resultados</h2>

            <div class="result-item">
                <div class="result-label">Raíz encontrada</div>
                <div class="result-value" id="raiz">-</div>
            </div>

            <div class="result-item">
                <div class="result-label">Valor f(x) en la raíz</div>
                <div class="result-value" id="fx">-</div>
            </div>

            <div class="result-item">
                <div class="result-label">Número de iteraciones</div>
                <div class="result-value" id="iteraciones">-</div>
            </div>

            <div class="result-item">
                <div class="result-label">Error estimado</div>
                <div class="result-value" id="error_estimado">-</div>
            </div>

            <h3>Historial de Iteraciones</h3>
            <table class="tabla">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>x</th>
                        <th>f(x)</th>
                        <th>Error</th>
                    </tr>
                </thead>
                <tbody id="tabla_cuerpo">
                </tbody>
            </table>
        </div>
    </main>

    <footer>
        <p>&copy; 2026 App de Métodos Numéricos - ESCOM</p>
    </footer>

    <script>
        function toggleAccordion(header) {
            // Cerrar otros acordeones
            const items = document.querySelectorAll('.accordion-header');
            items.forEach(item => {
                if (item !== header) {
                    item.classList.remove('active');
                    item.nextElementSibling.classList.remove('show');
                }
            });

            // Abrir/cerrar el actual
            header.classList.toggle('active');
            header.nextElementSibling.classList.toggle('show');
        }

        // Actualizar parámetros según el método seleccionado
        document.querySelectorAll('input[name="metodo"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const metodo = this.value;

                // Ocultar todos los parámetros
                document.getElementById('params_intervalo').style.display = 'none';
                document.getElementById('params_puntos_iniciales').style.display = 'none';
                document.getElementById('params_derivada').style.display = 'none';
                document.getElementById('params_iteracion').style.display = 'none';
                document.getElementById('params_x1').style.display = 'none';
                document.getElementById('params_x2').style.display = 'none';

                // Mostrar según el método seleccionado
                if (metodo === 'biseccion' || metodo === 'falsa_posicion') {
                    document.getElementById('params_intervalo').style.display = 'block';
                } else if (metodo === 'secante') {
                    document.getElementById('params_puntos_iniciales').style.display = 'block';
                    document.getElementById('params_x1').style.display = 'block';
                } else if (metodo === 'newton_raphson') {
                    document.getElementById('params_puntos_iniciales').style.display = 'block';
                    document.getElementById('params_derivada').style.display = 'block';
                } else if (metodo === 'punto_fijo') {
                    document.getElementById('params_puntos_iniciales').style.display = 'block';
                    document.getElementById('params_iteracion').style.display = 'block';
                } else if (metodo === 'muller') {
                    document.getElementById('params_puntos_iniciales').style.display = 'block';
                    document.getElementById('params_x1').style.display = 'block';
                    document.getElementById('params_x2').style.display = 'block';
                }
            });
        });

        async function calcular() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.remove('show');

            const metodo = document.querySelector('input[name="metodo"]:checked').value;
            const funcion = document.getElementById('funcion').value;
            const tolerancia = parseFloat(document.getElementById('tolerancia').value);
            const max_iteraciones = parseInt(document.getElementById('max_iteraciones').value);

            if (!funcion) {
                mostrarError('Por favor ingresa la función f(x)');
                return;
            }

            const data = {
                metodo: metodo,
                funcion: funcion,
                tolerancia: tolerancia,
                max_iteraciones: max_iteraciones
            };

            // Agregar parámetros según el método
            if (metodo === 'biseccion' || metodo === 'falsa_posicion') {
                const a = parseFloat(document.getElementById('a').value);
                const b = parseFloat(document.getElementById('b').value);
                if (isNaN(a) || isNaN(b)) {
                    mostrarError('Ingresa valores válidos para a y b');
                    return;
                }
                data.a = a;
                data.b = b;
            } else if (metodo === 'secante') {
                const x0 = parseFloat(document.getElementById('x0').value);
                const x1 = parseFloat(document.getElementById('x1').value);
                if (isNaN(x0) || isNaN(x1)) {
                    mostrarError('Ingresa valores válidos para x₀ y x₁');
                    return;
                }
                data.x0 = x0;
                data.x1 = x1;
            } else if (metodo === 'newton_raphson') {
                const x0 = parseFloat(document.getElementById('x0').value);
                const derivada = document.getElementById('derivada').value;
                if (isNaN(x0)) {
                    mostrarError('Ingresa un valor válido para x₀');
                    return;
                }
                if (!derivada) {
                    mostrarError('Ingresa la derivada f\'(x)');
                    return;
                }
                data.x0 = x0;
                data.derivada = derivada;
            } else if (metodo === 'punto_fijo') {
                const x0 = parseFloat(document.getElementById('x0').value);
                const g = document.getElementById('g').value;
                if (isNaN(x0)) {
                    mostrarError('Ingresa un valor válido para x₀');
                    return;
                }
                if (!g) {
                    mostrarError('Ingresa la función g(x)');
                    return;
                }
                data.x0 = x0;
                data.g = g;
            } else if (metodo === 'muller') {
                const x0 = parseFloat(document.getElementById('x0').value);
                const x1 = parseFloat(document.getElementById('x1').value);
                const x2 = parseFloat(document.getElementById('x2').value);
                if (isNaN(x0) || isNaN(x1) || isNaN(x2)) {
                    mostrarError('Ingresa valores válidos para x₀, x₁ y x₂');
                    return;
                }
                data.x0 = x0;
                data.x1 = x1;
                data.x2 = x2;
            }

            try {
                const response = await fetch('/api/ecuaciones-una-variable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const resultado = await response.json();

                if (response.ok) {
                    mostrarResultados(resultado);
                } else {
                    mostrarError(resultado.error);
                }
            } catch (error) {
                mostrarError('Error en la conexión: ' + error.message);
            }
        }

        function mostrarResultados(datos) {
            document.getElementById('raiz').textContent = datos.raiz.toFixed(8);
            document.getElementById('fx').textContent = datos.fx.toExponential(4);
            document.getElementById('iteraciones').textContent = datos.iteraciones;
            document.getElementById('error_estimado').textContent = datos.error_estimado.toExponential(4);

            // Llenar tabla
            const tbody = document.getElementById('tabla_cuerpo');
            tbody.innerHTML = '';

            datos.historial.forEach((item, index) => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.x.toFixed(8)}</td>
                    <td>${item.fx.toExponential(4)}</td>
                    <td>${item.error.toExponential(4)}</td>
                `;
                tbody.appendChild(fila);
            });

            // Mostrar sección de resultados
            document.getElementById('resultados').classList.add('show');
        }

        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = mensaje;
            errorDiv.classList.add('show');
        }

        function limpiar() {
            document.getElementById('formulario').reset();
            document.getElementById('resultados').classList.remove('show');
            document.getElementById('error').classList.remove('show');
            // Actualizar visibilidad de parámetros
            document.getElementById('params_intervalo').style.display = 'none';
            document.getElementById('params_puntos_iniciales').style.display = 'none';
            document.getElementById('params_derivada').style.display = 'none';
            document.getElementById('params_iteracion').style.display = 'none';
        }
    </script>
</body>
</html>
